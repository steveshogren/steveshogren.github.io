<!DOCTYPE html>
<!--[if lt IE 7]> <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]> <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]> <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Case Study: Superior Domain Modeling in F#  &middot; Deliberate Software</title>
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1">


<meta name="description" content="" />

<meta name="keywords" content="">


<meta property="og:title" content="Case Study: Superior Domain Modeling in F#  &middot; Deliberate Software ">
<meta property="og:site_name" content="Deliberate Software"/>
<meta property="og:url" content="http://deliberate-software.com/pattern-matching-case-study/" />
<meta property="og:locale" content="en-us">


<meta property="og:type" content="article" />
<meta property="og:description" content=""/>
<meta property="og:article:published_time" content="2015-03-14T00:00:00Z" />
<meta property="og:article:modified_time" content="2015-03-14T00:00:00Z" />

  

  
<meta name="twitter:card" content="summary" />
<meta name="twitter:site" content="@steveshogren" />
<meta name="twitter:creator" content="@steveshogren" />
<meta name="twitter:title" content="Case Study: Superior Domain Modeling in F#" />
<meta name="twitter:description" content="" />
<meta name="twitter:url" content="http://deliberate-software.com/pattern-matching-case-study/" />
<meta name="twitter:domain" content="http://deliberate-software.com/">
  
<script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "Article",
    "headline": "Case Study: Superior Domain Modeling in F#",
    "author": {
      "@type": "Person",
      "name": "http://profiles.google.com/+?rel=author"
    },
    "datePublished": "2015-03-14",
    "description": "",
    "wordCount":  669 
  }
</script>



<link rel="canonical" href="http://deliberate-software.com/pattern-matching-case-study/" />

<link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://deliberate-software.com/touch-icon-144-precomposed.png">
<link href="http://deliberate-software.com/favicon.png" rel="icon">

<meta name="generator" content="Hugo 0.15" />

  <!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
<script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
<![endif]-->



    <link rel="stylesheet" href="http://deliberate-software.com/css/theme/yeti.css">


<link rel="stylesheet" href="http://deliberate-software.com/css/font-awesome.min.css">
<link rel="stylesheet" href="http://deliberate-software.com/css/style.css">


  <link rel="stylesheet" href="http://deliberate-software.com/css/highlight/default.css">


</head>
<body class="map[name:yeti]">
    <header id="main-header">
  <nav class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header ">
        <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="http://deliberate-software.com/">Deliberate Software</a>
      </div>
      <div id="navbar" class="collapse navbar-collapse">
        <ul class="nav navbar-nav navbar-right">
            <li><a href="https://www.github.com/steveshogren"><span class="fa fa-github-square"></span> GitHub</a></li>
            <li><a href="/index.xml" rel="alternate" type="application/rss+xml"> <span class="fa fa-rss-square"></span> RSS</a></li>
          
          <li>
            <a href="http://deliberate-software.com/page/books"
             title="Show list of my favorite books">
            
            Favorite Books
            </a>
          </li>
          
          <li>
            <a href="http://deliberate-software.com/page/post"
             title="Show list of posts">
            
            All Posts
            </a>
          </li>
          
        </ul>
      </div>
      
    </div>
  </nav>

</header>


<div class="container">
    <div class="row">
        <div class="col-xs-12 col-sm-12 col-md-9 col-lg-9">
            <div class="text-center">
  <h1 class="">Case Study: Superior Domain Modeling in F#
</h1>

  <a href="https://twitter.com/share" class="twitter-share-button" data-via="steveshogren" data-size="large">Tweet</a>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>

<div class="metas col-md-12">
<small>
  <i class="fa fa-calendar"></i>
  <time datetime="2015-03-14">14 Mar, 2015</time>
</small>


  <small>
  &middot; Read in about 4 min
  &middot; (669 Words)
</small>



<div class="margin-12">
  <i class="fa fa-tags"></i>
  
  <a href="http://deliberate-software.com/categories/technical-skills" class="label label-default">Technical Skills</a>
  
  <a href="http://deliberate-software.com/categories/fsharp" class="label label-default">fsharp</a>
  
  <a href="http://deliberate-software.com/categories/csharp" class="label label-default">csharp</a>
  

 </div>
<br>
</div>

</div>

            <div class="">
    
  <div class="content">
    <p>Domain modeling in F# is significantly easier and safer than with the
traditional .NET languages. This is because of the increased safety of
pattern matching and the expressiveness of discriminated unions. These
concepts are not in C# or VB.NET, and therefore bring a new tool to
the table.</p>

<p>To illustrate this, I found some old code I&rsquo;d written to interact with
a legacy system. The system uses many single enums on a record to keep
track of statuses. When one changes, it can cause others to change as
well.</p>

<p>Here is a typical function that combines two enums to recalculate a
third.</p>

<pre><code class="language-csharp">public static PositionType GetPositionType (MovementType movementType, ApplyToParty applyToParty)
{
    if ((movementType == MovementType.Deliver &amp;&amp; applyToParty == ApplyToParty.Principal)
        || (movementType == MovementType.Return &amp;&amp; applyToParty == ApplyToParty.Counterparty))
        return PositionType.Held;
    if ((movementType == MovementType.Return &amp;&amp; applyToParty == ApplyToParty.Principal)
        || (movementType == MovementType.Deliver &amp;&amp; applyToParty == ApplyToParty.Counterparty))
        return PositionType.Posted;

    return PositionType.Undefined;
}
</code></pre>

<p>With some regularity, new records are added to these types of enums,
causing a dangerous search and update across the system fixing all the
if/else or switch/case statements.</p>

<p>Right off the bat, pattern matching is a huge win here, taking a hard
to comprehend function and making the domain concepts clear.</p>

<pre><code class="language-fsharp">let GetPositionType = function
    | Deliver, Principal | Return, Counterparty -&gt; Held
    | Return, Principal | Deliver, Counterparty -&gt; Posted
    | MovementType.Undefined, _ | _, ApplyToParty.Undefined -&gt; PositionType.Undefined
</code></pre>

<p>If we add a new status to any of these, we will get a compiler warning
in every place letting us know. If that alone was the win, we&rsquo;d be
still be ahead by a lot. The domain is so clear here, I can print this
code out and hand it to my BA to ensure the logic is correct.</p>

<p>Next though, this got me thinking. Why does this set of three enums
have to be calculated? Why are they even separate? Ah, of course,
right now they are stored in the database and ORM objects, each with a
separate field and set of enum ids. Changing that would be costly.</p>

<p>What I want is a domain layer a level higher than the typical database
ORM classes, something to convert my ORM classes into that will be
able to do work in a safer way.</p>

<p>Rather than three enums that are supposed to change in lock step (but
might get out of date), I really want a concept of the three combined
and &ldquo;frozen&rdquo; together.</p>

<pre><code class="language-fsharp">type Direction = 
    | Held_Deliver_Principal
    | Held_Return_Counterparty
    | Posted_Return_Principal
    | Posted_Deliver_Counterparty
    
let GetDirection = function
   | Deliver, Principal  -&gt; Held_Deliver_Principal
   | Return, Counterparty -&gt; Held_Return_Counterparty
   | Return, Principal -&gt; Posted_Return_Principal
   | Deliver, Counterparty -&gt; Posted_Deliver_Counterparty
</code></pre>

<p>Now I have a combined Direction that merges the three concepts into
one. It is impossible with this new merged type to have an invalid
state across the three. Getting any of the types back out to convert
into the ORM classes or do some work is as simple as another match:</p>

<pre><code class="language-fsharp">let GetMovementTypeToSaveInORM = function
   | Held_Deliver_Principal | Posted_Deliver_Counterparty -&gt; Deliver
   | Posted_Return_Principal | Held_Return_Counterparty -&gt; Return

let GetSendFn = function
   | Held_Deliver_Principal | Posted_Return_Principal -&gt; SendMessageToPrincipal
   | Held_Return_Counterparty | Posted_Deliver_Counterparty -&gt; SendMessageToCounterparty
</code></pre>

<p>While it is possible to make an equivalent C# enum and combine these
in a similar way, it is inherently unsafe (nothing to guarantee you
covered every case) and therefore appropriately uncommon. The typical
answer for safe polymorphic dispatch in C# is to use an interface and
classes. Unfortunately, something still has to dispatch on that enum
id, either inside a class or at the time of class instantiation. That
is a vector for errors.</p>

<p>Because F# interops so well with C#, it is possible to build in a
domain layer in F# immediately that calls down to your C# ORM
classes. Converting from a set of dangerous C# enums into a
constrained and safe F# discriminated union is easy and will simplify
your domain to its essence.</p>

<p>For reasons like this, when I have to build something with a rich
domain, I reach for F#.</p>

  </div>
</div>


            <footer>
  <div class="centereded">
    <a href="https://twitter.com/share" class="twitter-share-button" data-via="steveshogren" data-size="large">Tweet</a>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>

</div>
<div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
      
  
    <nav><ul class="pager">
    
        <li class="previous">
          <a href="http://deliberate-software.com/programming-language-safety-algorithm/" title="Programming Language Safety Ranking">
            <span aria-hidden="true">&larr;</span>Previous
          </a>
        </li>
    

    
      <li class="next">
        <a href="http://deliberate-software.com/superiority-fatigue/" title="Superiority Fatigue">
            Next <span aria-hidden="true">&rarr;</span>
        </a>
      </li>
    
    </ul> </nav>
  


</div>

  <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
  

</div>

</footer>

        </div>
        <div class="col-xs-12 col-sm-12 col-md-3 col-lg-3 col-xl-3">
            <h3 class="serif col-sm-12 centereded" id="name">Steve Shogren</h3>
<span class="col-md-3"></span>
<img class="col-md-6 border" id="avatar" src="http://deliberate-software.com//images/me_updated3.png" />
<span class="col-md-3"></span>
<span class="col-md-12 centereded">
<a href="https://twitter.com/steveshogren" class="twitter-follow-button" data-show-count="false" data-size="large">Follow @steveshogren</a>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
</span>
<span class="col-sm-12">
    Insights gathered while learning to deliberately craft software and burn bridges.
</span>
<h3 class="col-sm-12 centereded" id="name">Too many great ideas? Check out my new book!</h3>

<a class="col-sm-12" href="https://leanpub.com/convincingcoworkers">
    <img class="book" src="/images/convincingcoworkerscover.jpg"></img>
</a>

<h3 class="col-sm-12" id="name">Top Posts</h3>
<div class="col-sm-12">
    <ul class="sidebar_ul">
        
        <li class="sidebar_li"><a href="http://deliberate-software.com/haskell-is-the-dark-souls-of-programming/">Haskell is the Dark Souls of Programming</a></li>
        
        <li class="sidebar_li"><a href="http://deliberate-software.com/on-defeat/">Interview Humiliation</a></li>
        
        <li class="sidebar_li"><a href="http://deliberate-software.com/unusual-reasons-why-clojure-is-a-delight/">Six Unusual Reasons why Clojure is a Delight</a></li>
        
        <li class="sidebar_li"><a href="http://deliberate-software.com/function-pattern-matching/">Pattern Matching - Making the Compiler Work For You</a></li>
        
        <li class="sidebar_li"><a href="http://deliberate-software.com/ego-driven-development/">Ego Driven Development</a></li>
        
    </ul>
</div>
<h3 class="col-sm-12" id="name">Categories</h3>
<div class="col-sm-12">
    <ul class="sidebar_ul">
        
        <li class="sidebar_li">
            <a href="/categories/angular">angular</a> <span class="badge">2</span>
        </li>
        
        <li class="sidebar_li">
            <a href="/categories/architecture">architecture</a> <span class="badge">3</span>
        </li>
        
        <li class="sidebar_li">
            <a href="/categories/clojure">clojure</a> <span class="badge">11</span>
        </li>
        
        <li class="sidebar_li">
            <a href="/categories/clojurescript">clojurescript</a> <span class="badge">2</span>
        </li>
        
        <li class="sidebar_li">
            <a href="/categories/csharp">csharp</a> <span class="badge">4</span>
        </li>
        
        <li class="sidebar_li">
            <a href="/categories/emacs">emacs</a> <span class="badge">2</span>
        </li>
        
        <li class="sidebar_li">
            <a href="/categories/fsharp">fsharp</a> <span class="badge">7</span>
        </li>
        
        <li class="sidebar_li">
            <a href="/categories/haskell">haskell</a> <span class="badge">2</span>
        </li>
        
        <li class="sidebar_li">
            <a href="/categories/interviews">interviews</a> <span class="badge">2</span>
        </li>
        
        <li class="sidebar_li">
            <a href="/categories/management">management</a> <span class="badge">9</span>
        </li>
        
        <li class="sidebar_li">
            <a href="/categories/meta-game">meta-game</a> <span class="badge">25</span>
        </li>
        
        <li class="sidebar_li">
            <a href="/categories/technical-skills">technical-skills</a> <span class="badge">25</span>
        </li>
        
        <li class="sidebar_li">
            <a href="/categories/unit-testing">unit-testing</a> <span class="badge">7</span>
        </li>
        
    </ul>
</div>

        </div>
    </div>
</div>
      <footer class="footer">
    <div class="container hidden-print">
    <div class="row">
        <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
           <div class="pull-left">
  <a class="toplink" href="#">back to top</a>
</div>
<div class="pull-right">
  
</div>

        </div>
        <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12 text-center">
          <small>
              
    

    


          </small>
        </div>
     </div>
    </div>
</footer>

    <script src="http://deliberate-software.com/js/jquery.min-2.1.4.js"></script>
<script src="http://deliberate-software.com/js/bootstrap.min-3.3.5.js"></script>




<script src="http://deliberate-software.com/js/highlight.pack.js"></script>
<script src="http://deliberate-software.com/js/site.js"></script>
<script>hljs.initHighlightingOnLoad();</script>


<script>
if (document.location.hostname.search("deliberate-software.com") !== -1) {
  var _gaq=[['_setAccount','UA-46040901-1'],['_trackPageview']];
  (function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];
  g.src=('https:'==location.protocol?'//ssl':'//www')+'.google-analytics.com/ga.js';
  s.parentNode.insertBefore(g,s)}(document,'script'));
}
</script>


  </body>
</html>

