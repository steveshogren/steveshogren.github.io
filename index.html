
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Deliberate Software</title>
  <meta name="author" content="Steve Shogren">

  
<<<<<<< HEAD
  <meta name="description" content="If you are considering using F#, you might be curious how to handle unit test
mocking, especially if you want to use both modules and classes. In a &hellip;">
=======
  <meta name="description" content="SimpleMock is a pattern for reducing TDD damage. You can use the pattern to
organize your testing code without mocking or complicated dependency &hellip;">
>>>>>>> 9746fb2699c65d83fea530ecbb324e98d6468c7b
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">
<<<<<<< HEAD

  
  <link rel="canonical" href="http://steveshogren.github.io/">
=======
  <link href="/stylesheets/data-table.css" media="screen, projection" rel="stylesheet" type="text/css" />

  
  <link rel="canonical" href="http://steveshogren.github.io">
>>>>>>> 9746fb2699c65d83fea530ecbb324e98d6468c7b
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Deliberate Software" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
<<<<<<< HEAD
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
=======
  <!-- <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>  -->
  <script src="/javascripts/libs/jquery.min.js"></script> 
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
>>>>>>> 9746fb2699c65d83fea530ecbb324e98d6468c7b
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

<script src="/javascripts/libs/angular.js"></script>

<<<<<<< HEAD
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-46040901-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>

=======
  <script type="text/javascript">
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-46040901-1', 'deliberate-software.com');
  ga('send', 'pageview');
</script>
>>>>>>> 9746fb2699c65d83fea530ecbb324e98d6468c7b

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Deliberate Software</a></h1>
  
    <h2>With deliberate practice come consistent results</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
<<<<<<< HEAD
    <input type="hidden" name="sitesearch" value="steveshogren.github.io">
=======
    <input type="hidden" name="q" value="site:steveshogren.github.io" />
>>>>>>> 9746fb2699c65d83fea530ecbb324e98d6468c7b
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Home</a></li>
<<<<<<< HEAD
  <li><a href="/blog/archives">All Posts</a></li>
=======
  <li><a href="/blog/categories/technical-skills/">Technical Skills</a></li>
  <li><a href="/blog/categories/meta-game/">Meta Game</a></li>
  <li><a href="/blog/archives">All</a></li>
>>>>>>> 9746fb2699c65d83fea530ecbb324e98d6468c7b
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
<<<<<<< HEAD
      <h1 class="entry-title"><a href="/f-number-unit-testing/">F# Unit Testing With SimpleMock</a></h1>
=======
      <h1 class="entry-title"><a href="/simplemock-unit-test-mocking/">SimpleMock: Language Agnostic Unit Test Mocking</a></h1>
>>>>>>> 9746fb2699c65d83fea530ecbb324e98d6468c7b
    
    
      <p class="meta">
        
<<<<<<< HEAD




<time class='entry-date' datetime='2015-10-21T16:41:00-04:00'><span class='date'><span class='date-month'>Oct</span> <span class='date-day'>21</span><span class='date-suffix'>st</span>, <span class='date-year'>2015</span></span> <span class='time'>4:41 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>If you are considering using F#, you might be curious how to handle unit test
mocking, especially if you want to use both modules and classes. In a language
like C# or Java, the common method is to a DI container or handmade constructor
injection on a class. These &ldquo;entry points&rdquo; allow for a unit test to replace a
real dependency with a test-only replacement.</p>

<p>I previously posted an example that shows a much simpler way to inject
dependencies called the <a href="http://deliberate-software.com/simplemock-unit-test-mocking/">SimpleMock pattern</a>. The SimpleMock pattern can also be
used in F#, even if you are only using modules.</p>

<h2>SimpleMock in F# Modules</h2>

<p>We will assume you are mocking inside a module and not a class. Mocking inside
an F# class would look much the same as it does in C#, which we showed in the
SimpleMock post. Here is a sample program that does some work and persists the
results.</p>
=======
      </p>
    
  </header>


  <div class="entry-content"><p>SimpleMock is a pattern for reducing TDD damage. You can use the pattern to
organize your testing code without mocking or complicated dependency injection.</p>

<p>SimpleMock works in any language with closures that can be passed around by
reference, so off the top of my head: C#, Java, F#, Scala, PHP, C++, Ruby, and
Python. I&rsquo;m sure you can think of others.</p>

<h1>Benefits</h1>

<ul>
<li>Reduced boilerplate</li>
<li>Saves interfaces for real polymorphism</li>
<li>Simplifies test code</li>
<li>Reduces testing concerns in production code</li>
<li>Removes need for fragile IoC containers</li>
<li>Encourages better abstraction design</li>
<li>Can convert one class at a time!</li>
</ul>


<p>The SimpleMock pattern promotes a better design of your abstractions and simpler
tests. The pattern also reduces boilerplate and the pollution of your production
code with testing concerns.</p>

<p>If you aren&rsquo;t familiar with the normal pattern of unit test mocking using
interfaces, dependency injection, and mock libraries, scroll down to &ldquo;The
Non-SimpleMock Way&rdquo; at the end of the post.</p>

<h1>SimpleMock Pattern</h1>

<p>The SimpleMock pattern is aptly named.</p>

<ol>
<li>Replace Test-Only Interfaces With Functions</li>
<li>Define Dependencies Inline</li>
<li>Write Better Abstractions</li>
</ol>


<h1>Step One: Replace Test-Only Interfaces With Functions</h1>

<p>My examples are in C# because that is what I got paid to write today &ndash; it is
freshest in memory. C# has an incredible ability to create and pass around
lambdas and function references. Here is an example of using functions instead
of interfaces.</p>
>>>>>>> 9746fb2699c65d83fea530ecbb324e98d6468c7b

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<<<<<<< HEAD
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'><span class="k">let</span> <span class="nv">addAndSave</span> <span class="n">x</span> <span class="n">y</span> <span class="o">=</span>
</span><span class='line'>  <span class="k">let</span> <span class="nv">sum</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>
</span><span class='line'>  <span class="nn">DBModule</span><span class="p">.</span><span class="n">saveSum</span> <span class="n">sum</span>
</span><span class='line'>  <span class="n">sum</span>
</span></code></pre></td></tr></table></div></figure>


<p></p>

<p>To apply the SimpleMock pattern, we can use argument currying by adding a simple
function wrapper.</p>
=======
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">CurrentTime</span> <span class="p">:</span> <span class="n">ICurrentTime</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">public</span> <span class="n">DateTime</span> <span class="nf">GetCurrentTime</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">DateTime</span><span class="p">.</span><span class="n">Now</span><span class="p">();</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">Translator</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">private</span> <span class="n">Func</span><span class="p">&lt;</span><span class="n">DateTime</span><span class="p">&gt;</span> <span class="n">_getCurrentTime</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="nf">Translator</span><span class="p">()</span> <span class="p">:</span> <span class="k">this</span><span class="p">(</span><span class="k">new</span> <span class="n">CurrentTime</span><span class="p">().</span><span class="n">GetCurrentTime</span><span class="p">)</span> <span class="p">{}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="nf">Translator</span><span class="p">(</span><span class="n">Func</span><span class="p">&lt;</span><span class="n">DateTime</span><span class="p">&gt;</span> <span class="n">getCurrentTime</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">this</span><span class="p">.</span><span class="n">_getCurrentTime</span> <span class="p">=</span> <span class="n">getCurrentTime</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="kt">string</span> <span class="nf">Translate</span><span class="p">(</span><span class="kt">string</span> <span class="n">input</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="kt">string</span><span class="p">.</span><span class="n">Format</span><span class="p">(</span><span class="s">&quot;{0}: {1}&quot;</span><span class="p">,</span> <span class="n">_getCurrentTime</span><span class="p">().</span><span class="n">ToString</span><span class="p">(),</span> <span class="n">input</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">/// Test Code with just lambdas</span>
</span><span class='line'><span class="na">[TestCase]</span>
</span><span class='line'><span class="k">public</span> <span class="k">void</span> <span class="nf">TestCurrentTimeTranslator</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="kt">var</span> <span class="n">now</span> <span class="p">=</span> <span class="n">DateTime</span><span class="p">.</span><span class="n">Now</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="kt">var</span> <span class="n">sut</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Translator</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="n">now</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="kt">var</span> <span class="n">result</span> <span class="p">=</span> <span class="n">sut</span><span class="p">.</span><span class="n">Translate</span><span class="p">(</span><span class="s">&quot;test&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">Assert</span><span class="p">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="n">now</span><span class="p">.</span><span class="n">ToString</span><span class="p">()</span> <span class="p">+</span> <span class="s">&quot;: test&quot;</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The test code is quite simple! No longer do we need the dependency on third
party mocking libraries, or the relatively complicated setup logic. Instead we
can simply inject the lambda at runtime, replacing that pointer. We didn&rsquo;t need
the whole interface, really we just needed the simple signature of the function.</p>

<h1>Step 2: Define Dependencies Inline</h1>

<p>We can take it even a step further. Why use constructor injection at all? Since
all we really want is a single mutable dispatch table row, why not just make it
that way?</p>
>>>>>>> 9746fb2699c65d83fea530ecbb324e98d6468c7b

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<<<<<<< HEAD
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'><span class="k">let</span> <span class="nv">addAndSave</span><span class="k">&#39;</span> <span class="n">saveSum</span> <span class="n">x</span> <span class="n">y</span> <span class="o">=</span>
</span><span class='line'>  <span class="k">let</span> <span class="nv">sum</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>
</span><span class='line'>  <span class="n">saveSum</span> <span class="n">sum</span>
</span><span class='line'>  <span class="n">sum</span>
</span><span class='line'><span class="k">let</span> <span class="nv">addAndSave</span> <span class="o">=</span> <span class="n">addAndSave&#39;</span> <span class="nn">DBModule</span><span class="p">.</span><span class="n">saveSum</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Test code</span>
</span><span class='line'><span class="k">let</span> <span class="nv">addAndSave_Test</span> <span class="o">=</span>
</span><span class='line'>  <span class="k">let</span> <span class="nv">calledVar</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">0</span>
</span><span class='line'>  <span class="k">let</span> <span class="nv">result</span> <span class="o">=</span> <span class="n">addAndSave&#39;</span> <span class="o">(</span><span class="k">fun</span> <span class="n">sum</span> <span class="o">-&gt;</span> <span class="n">calledVar</span> <span class="o">:=</span> <span class="n">sum</span><span class="o">)</span> <span class="mi">1</span> <span class="mi">2</span>
</span><span class='line'>  <span class="nn">Assert</span><span class="p">.</span><span class="n">AreEqual</span><span class="o">(</span><span class="mi">3</span><span class="o">,</span> <span class="n">result</span><span class="o">)</span>
</span><span class='line'>  <span class="nn">Assert</span><span class="p">.</span><span class="n">AreEqual</span><span class="o">(</span><span class="mi">3</span><span class="o">,</span> <span class="o">!</span><span class="n">calledVar</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p></p>

<p>We started by renaming the <code>addAndSave</code> function with a trailing <code>'</code>. We
created a new <code>addAndSave</code> that calls <code>addAndSave'</code> with the correct
dependency for the first argument, leaving the rest of the arguments to be
called later. Currying is what allows this ability. The new <code>addAndSave</code>
function only needs the <code>x</code> and <code>y</code> parameters. At test time, we called <code>addAndSave'</code>, passing in the needed dependency, but using a lambda as the
&ldquo;fake&rdquo;. The injection is as close to the dependency use as possible!</p>

<h2>Bonus: SimpleMock Fake Helper</h2>

<p>The earlier replacement for DBModule.saveSum is a bit complex, and it does not
show us how many times the fake was called. We can easily make a helper that
takes parameters and returns them when called, along withe count of times it was
called.</p>
=======
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">Translator</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">internal</span> <span class="n">Func</span><span class="p">&lt;</span><span class="n">DateTime</span><span class="p">&gt;</span> <span class="n">_getCurrentTime</span> <span class="p">=</span> <span class="k">new</span> <span class="n">CurrentTime</span><span class="p">().</span><span class="n">GetCurrentTime</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="kt">string</span> <span class="nf">Translate</span><span class="p">(</span><span class="kt">string</span> <span class="n">input</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="kt">string</span><span class="p">.</span><span class="n">Format</span><span class="p">(</span><span class="s">&quot;{0}: {1}&quot;</span><span class="p">,</span> <span class="n">_getCurrentTime</span><span class="p">().</span><span class="n">ToString</span><span class="p">(),</span> <span class="n">input</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">/// Test Code with just inline lambdas</span>
</span><span class='line'><span class="na">[TestCase]</span>
</span><span class='line'><span class="k">public</span> <span class="k">void</span> <span class="nf">TestCurrentTimeTranslator</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="kt">var</span> <span class="n">now</span> <span class="p">=</span> <span class="n">DateTime</span><span class="p">.</span><span class="n">Now</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">var</span> <span class="n">sut</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Translator</span><span class="p">();</span>
</span><span class='line'>    <span class="n">sut</span><span class="p">.</span><span class="n">_getCurrentTime</span> <span class="p">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="n">now</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="kt">var</span> <span class="n">result</span> <span class="p">=</span> <span class="n">sut</span><span class="p">.</span><span class="n">Translate</span><span class="p">(</span><span class="s">&quot;test&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">Assert</span><span class="p">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="n">now</span><span class="p">.</span><span class="n">ToString</span><span class="p">()</span> <span class="p">+</span> <span class="s">&quot;: test&quot;</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now we&rsquo;ve cleaned up our nasty multi-line indirection into a single dispatch
line! &ldquo;Go to definition&rdquo; now takes me to the actual line with the actual called
function! We&rsquo;ve replaced a dependency on a class based interface with a function
signature. The function signature <em>is</em> the interface!</p>

<p>You probably noticed we have lost something with this final version. We have
lost the ability to inject polymorphic behavior through the constructor. If you
need it, simply go back to injecting the interface in the constructor or by
passing it into the function itself. In practice, I have found this is needed
very rarely, making the SimpleMock pattern a better tool to reach for first.</p>

<h1>Step 3: Write Better Abstractions</h1>

<p>Lastly, SimpleMock actually promotes better designs. For example, a coworker was
writing some tests today and ran into a complicated situation. Take the
following sanitized code:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">WorkDoer</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">internal</span> <span class="n">Action</span><span class="p">&lt;</span><span class="n">Thing</span><span class="p">&gt;</span> <span class="n">ignoreElements</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ThingIgnorer</span><span class="p">().</span><span class="n">IgnoreElements</span><span class="p">;</span>
</span><span class='line'>    <span class="k">internal</span> <span class="n">Action</span><span class="p">&lt;</span><span class="n">Thing</span><span class="p">&gt;</span> <span class="n">removeIgnoredElements</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ThingRemover</span><span class="p">().</span><span class="n">RemoveElements</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="k">void</span> <span class="nf">IgnoreAndRemoveThings</span><span class="p">(</span><span class="n">Thing</span> <span class="n">t1</span><span class="p">,</span> <span class="n">Thing</span> <span class="n">t2</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">ignoreElements</span><span class="p">(</span><span class="n">t1</span><span class="p">);</span>
</span><span class='line'>        <span class="n">ignoreElements</span><span class="p">(</span><span class="n">t2</span><span class="p">);</span>
</span><span class='line'>        <span class="n">removeIgnoredElements</span><span class="p">(</span><span class="n">t1</span><span class="p">);</span>
</span><span class='line'>        <span class="n">removeIgnoredElements</span><span class="p">(</span><span class="n">t2</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>How would you check that each section was called? Our naive solution was a
complicated lambda with a &ldquo;timesCalled&rdquo; counter and an if statement to assert
against each argument, but it turns nasty quickly:</p>
>>>>>>> 9746fb2699c65d83fea530ecbb324e98d6468c7b

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<<<<<<< HEAD
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'><span class="k">type</span> <span class="nc">TestFakeResults</span><span class="bp">()</span> <span class="o">=</span>
</span><span class='line'>  <span class="k">member</span> <span class="k">val</span> <span class="n">timesCalled</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">with</span> <span class="n">get</span><span class="o">,</span><span class="n">set</span>
</span><span class='line'>  <span class="k">member</span> <span class="k">val</span> <span class="n">args</span><span class="o">:</span> <span class="kt">obj</span> <span class="kt">list</span> <span class="o">=</span> <span class="bp">[]</span> <span class="k">with</span> <span class="n">get</span><span class="o">,</span><span class="n">set</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="nv">makeFake_OneArg</span> <span class="bp">()</span> <span class="o">=</span>
</span><span class='line'>  <span class="k">let</span> <span class="nv">results</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TestFakeResults</span><span class="bp">()</span>
</span><span class='line'>  <span class="k">let</span> <span class="nv">fake</span> <span class="o">=</span> <span class="o">(</span><span class="k">fun</span> <span class="n">p1</span> <span class="o">-&gt;</span>
</span><span class='line'>                  <span class="n">results</span><span class="o">.</span><span class="n">args</span> <span class="o">&lt;-</span> <span class="n">p1</span> <span class="o">::</span> <span class="n">results</span><span class="o">.</span><span class="n">args</span>
</span><span class='line'>                  <span class="n">results</span><span class="o">.</span><span class="n">timesCalled</span> <span class="o">&lt;-</span> <span class="n">results</span><span class="o">.</span><span class="n">timesCalled</span> <span class="o">+</span> <span class="mi">1</span>
</span><span class='line'>                  <span class="bp">()</span><span class="o">)</span>
</span><span class='line'>  <span class="o">(</span><span class="n">fake</span><span class="o">,</span> <span class="n">results</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>The above code might be hard to comprehend at first! We have made a generic
helper that can create any single argument fake we need. We return a tuple,
containing the fake lambda and an instance of <code>TestFakeResults</code>. The fake
lambda will populate the <code>TestFakeResults</code>, which we can access in the test
via the second arg of the tuple.</p>

<p>We can now re-write the previous test using <code>makeFake_OneArg</code>:</p>
=======
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="c1">/// Nasty test code</span>
</span><span class='line'><span class="na">[TestCase]</span>
</span><span class='line'><span class="k">public</span> <span class="k">void</span> <span class="nf">TestWorkDoer</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="kt">var</span> <span class="n">sut</span> <span class="p">=</span> <span class="k">new</span> <span class="n">WorkDoer</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="kt">var</span> <span class="n">ignoredCalledTimes</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
</span><span class='line'>    <span class="n">sut</span><span class="p">.</span><span class="n">ignoreElements</span> <span class="p">=</span> <span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">ignoredCalledTimes</span><span class="p">++;</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">ignoredCalledTimes</span> <span class="p">==</span> <span class="m">1</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">Assert</span><span class="p">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="n">t</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">Assert</span><span class="p">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span> <span class="n">t</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'>    <span class="kt">var</span> <span class="n">removedCalledTimes</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
</span><span class='line'>    <span class="n">sut</span><span class="p">.</span><span class="n">removeIgnoredElements</span> <span class="p">=</span> <span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">removedCalledTimes</span><span class="p">++;</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">removedCalledTimes</span> <span class="p">==</span> <span class="m">1</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">Assert</span><span class="p">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="n">t</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">Assert</span><span class="p">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span> <span class="n">t</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>    <span class="kt">var</span> <span class="n">t1</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Thing</span><span class="p">();</span>
</span><span class='line'>    <span class="kt">var</span> <span class="n">t2</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Thing</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="kt">var</span> <span class="n">result</span> <span class="p">=</span> <span class="n">sut</span><span class="p">.</span><span class="n">IgnoreAndRemoveThings</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">);</span>
</span><span class='line'>    <span class="n">Assert</span><span class="p">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="m">2</span><span class="p">,</span> <span class="n">removedCalledTimes</span><span class="p">);</span>
</span><span class='line'>    <span class="n">Assert</span><span class="p">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="m">2</span><span class="p">,</span> <span class="n">ignoredCalledTimes</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Yuck! The test is an absolute catastrophe. I see a mess of mixed concerns.
Conditionals?! In a test?! Unconscionable.</p>

<p>In situations like this, we have two easy options. Option one is to just use
a third party mocking library, replacing the functions from inside the test
code. This gives us access to all the sophisticated mocking tools available.</p>

<p>My preferred option is seeking to decomplect the production code by using better
abstractions.</p>

<p>I have found that strong reliance of mocking libraries enables worse designs.
Consider the code, what makes it so hard to test? Not knowing which element is
called when, doing the same work on two parameters, and reference mutation all
make this a poor abstraction. Why not simplify?</p>
>>>>>>> 9746fb2699c65d83fea530ecbb324e98d6468c7b

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<<<<<<< HEAD
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'><span class="c1">// Test code</span>
</span><span class='line'><span class="k">let</span> <span class="nv">addAndSave_Test</span> <span class="o">=</span>
</span><span class='line'>  <span class="k">let</span> <span class="o">(</span><span class="n">fakeSave</span><span class="o">,</span> <span class="n">fakeSaveCalling</span><span class="o">)</span> <span class="o">=</span> <span class="n">makeFake_OneArg</span><span class="bp">()</span>
</span><span class='line'>  <span class="k">let</span> <span class="nv">result</span> <span class="o">=</span> <span class="n">addAndSave&#39;</span> <span class="n">fakeSave</span> <span class="mi">1</span> <span class="mi">2</span>
</span><span class='line'>  <span class="nn">Assert</span><span class="p">.</span><span class="n">AreEqual</span><span class="o">(</span><span class="mi">3</span><span class="o">,</span> <span class="n">result</span><span class="o">)</span>
</span><span class='line'>  <span class="nn">Assert</span><span class="p">.</span><span class="n">AreEqual</span><span class="o">(</span><span class="mi">3</span><span class="o">,</span> <span class="n">fakeSaveCalling</span><span class="o">.</span><span class="n">args</span><span class="o">.[</span><span class="mi">0</span><span class="o">])</span>
</span><span class='line'>  <span class="nn">Assert</span><span class="p">.</span><span class="n">AreEqual</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">fakeSaveCalling</span><span class="o">.</span><span class="n">timesCalled</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p></p>

<p>The TestFakeResults can return information about the way it was called,
including the list of all arguments. If we felt we needed the extra
expressiveness, we could also use a mocking library like RhinoMocks or Moq. The
TestFakeResults and its constructor are not essential to the pattern. The most
important part is learning to unit test in F# with confidence.</p>

<h1>Double Bonus: When to Use a Class Instead of a Record</h1>

<p>When I first wrote this post, I used a record instead of a class for the <code>TestFakeResults</code> type. If you have been bitten by the functional programming bug,
you might have wondered at my usage of a mutable class. Here are two alternates
of <code>makeFake_OneArg</code> which use records. You can probably see why I switched to a class:</p>
=======
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">WorkDoer</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">internal</span> <span class="n">Func</span><span class="p">&lt;</span><span class="n">Thing</span><span class="p">,</span> <span class="n">Thing</span><span class="p">&gt;</span> <span class="n">ignoreElements</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ThingIgnorer</span><span class="p">().</span><span class="n">IgnoreElements</span><span class="p">;</span>
</span><span class='line'>    <span class="k">internal</span> <span class="n">Func</span><span class="p">&lt;</span><span class="n">Thing</span><span class="p">,</span> <span class="n">Thing</span><span class="p">&gt;</span> <span class="n">removeIgnoredElements</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ThingRemover</span><span class="p">().</span><span class="n">RemoveElements</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">Thing</span><span class="p">&gt;</span> <span class="n">IgnoreAndRemoveThings</span><span class="p">(</span><span class="n">List</span><span class="p">&lt;</span><span class="n">Thing</span><span class="p">&gt;</span> <span class="n">ts</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">ts</span><span class="p">.</span><span class="n">Select</span><span class="p">(</span><span class="n">t</span> <span class="p">=&gt;</span> <span class="n">removeIgnoredElements</span><span class="p">(</span><span class="n">ignoreElements</span><span class="p">(</span><span class="n">t</span><span class="p">)));</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">/// Simpler test</span>
</span><span class='line'><span class="na">[TestCase]</span>
</span><span class='line'><span class="k">public</span> <span class="k">void</span> <span class="nf">TestWorkDoer</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="kt">var</span> <span class="n">sut</span> <span class="p">=</span> <span class="k">new</span> <span class="n">WorkDoer</span><span class="p">();</span>
</span><span class='line'>    <span class="kt">var</span> <span class="n">expected</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Thing</span><span class="p">();</span>
</span><span class='line'>    <span class="kt">var</span> <span class="n">ts</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">Thing</span><span class="p">&gt;{</span><span class="k">new</span> <span class="n">Thing</span><span class="p">()};</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">sut</span><span class="p">.</span><span class="n">ignoreElements</span> <span class="p">=</span> <span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="k">new</span> <span class="n">Thing</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">sut</span><span class="p">.</span><span class="n">removeIgnoredElements</span> <span class="p">=</span> <span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">Assert</span><span class="p">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">sut</span><span class="p">.</span><span class="n">ignoreElements</span><span class="p">(</span><span class="n">t</span><span class="p">));</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">expected</span><span class="p">;</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>    <span class="kt">var</span> <span class="n">result</span> <span class="p">=</span> <span class="n">sut</span><span class="p">.</span><span class="n">IgnoreAndRemoveThings</span><span class="p">(</span><span class="n">ts</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">Assert</span><span class="p">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">result</span><span class="p">.</span><span class="n">First</span><span class="p">())</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Much better! Yes, we had to change a few signatures. We get the same work done,
but now the code is actually a lot more useful. Our test code is absolutely
comparable with anything you&rsquo;d find using a mocking library. I am absolutely
okay with using a mocking library when absolutely needed, but I always carefully
consider my abstractions and design first.</p>

<p>If mocking libraries and IoC containers are the chainsaws of the testing world,
then SimpleMock is the garden shears. Sometimes the chainsaw is absolutely the
only tool for the job, and that is fine. But for most work around the yard, you
can leave the chainsaw in the shed.</p>

<h1>Conclusion</h1>

<p>I’ve shown how you can really simplify your code with SimpleMock. The dispatch
row is clear and easy to read. We have removed some third party mocking
dependencies. You can remove a lot of the boilerplate &ldquo;for making it more
testable&rdquo; from your code. The test code is greatly simplified, and injection a
breeze. The result: much simpler code, just as easy to test.</p>

<p>Thanks to Shuwei Chen for helping me put this together!</p>

<h1>The Non-SimpleMock Way</h1>

<p>If you are familiar with unit test mocking with interfaces, this part is
probably boring. Feel free to skip.</p>

<p>The traditional way of performing C# unit test mocking involves dependency
injection and interface mocking using a mocking library. For dependency
injection, it is common to use a tool like Ninject or hand-rolled constructor
injection. For mocking, a library like Moq or Rhino Mocks is standard. Here is
an example of a class and its testing code without any business logic.</p>
>>>>>>> 9746fb2699c65d83fea530ecbb324e98d6468c7b

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<<<<<<< HEAD
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'><span class="k">type</span> <span class="nc">TestFakeResults</span> <span class="o">=</span> <span class="o">{</span><span class="n">timesCalled</span><span class="o">:</span><span class="n">int</span><span class="o">,</span> <span class="n">args</span> <span class="kt">obj</span> <span class="kt">list</span><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Using Record Alternate 1</span>
</span><span class='line'><span class="k">let</span> <span class="nv">makeFake_OneArg_RecordAlternate1</span> <span class="bp">()</span> <span class="o">=</span>
</span><span class='line'>  <span class="k">let</span> <span class="nv">t</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">0</span>
</span><span class='line'>  <span class="k">let</span> <span class="nv">a</span> <span class="o">:</span> <span class="kt">obj</span> <span class="kt">list</span> <span class="n">ref</span> <span class="o">=</span> <span class="n">ref</span> <span class="bp">[]</span>
</span><span class='line'>  <span class="k">let</span> <span class="nv">fake</span> <span class="o">=</span> <span class="o">(</span><span class="k">fun</span> <span class="n">p1</span> <span class="o">-&gt;</span>
</span><span class='line'>                  <span class="n">a</span> <span class="o">:=</span> <span class="n">p1</span> <span class="o">::</span> <span class="o">!</span><span class="n">a</span>
</span><span class='line'>                  <span class="n">t</span> <span class="o">:=</span> <span class="o">!</span><span class="n">t</span> <span class="o">+</span> <span class="mi">1</span>
</span><span class='line'>                  <span class="bp">()</span><span class="o">)</span>
</span><span class='line'>  <span class="o">(</span><span class="n">fake</span><span class="o">,</span> <span class="o">(</span><span class="k">fun</span> <span class="bp">()</span> <span class="o">-&gt;</span>
</span><span class='line'>                <span class="o">{</span><span class="nn">TestFakeRecord</span><span class="p">.</span><span class="n">timesCalled</span> <span class="o">=</span> <span class="o">!</span><span class="n">t</span><span class="o">;</span>
</span><span class='line'>                 <span class="n">args</span> <span class="o">=</span> <span class="o">!</span><span class="n">a</span><span class="o">}))</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Using Record Alternate 2</span>
</span><span class='line'><span class="k">let</span> <span class="nv">makeFake_OneArg_RecordAlternate2</span> <span class="bp">()</span> <span class="o">=</span>
</span><span class='line'>  <span class="k">let</span> <span class="nv">result</span> <span class="o">=</span> <span class="n">ref</span> <span class="o">{</span><span class="nn">TestFakeRecord</span><span class="p">.</span><span class="n">timesCalled</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">args</span> <span class="o">=</span> <span class="bp">[]</span><span class="o">}</span>
</span><span class='line'>  <span class="k">let</span> <span class="nv">fake</span> <span class="o">=</span> <span class="o">(</span><span class="k">fun</span> <span class="n">p1</span> <span class="o">-&gt;</span>
</span><span class='line'>              <span class="n">result</span> <span class="o">:=</span> <span class="o">{</span><span class="n">timesCalled</span> <span class="o">=</span> <span class="o">(!</span><span class="n">result</span><span class="o">).</span><span class="n">timesCalled</span> <span class="o">+</span> <span class="mi">1</span><span class="o">;</span>
</span><span class='line'>                         <span class="n">args</span> <span class="o">=</span> <span class="n">p1</span> <span class="o">::</span> <span class="o">(!</span><span class="n">result</span><span class="o">).</span><span class="n">args</span><span class="o">}</span>
</span><span class='line'>              <span class="bp">()</span><span class="o">)</span>
</span><span class='line'>  <span class="o">(</span><span class="n">fake</span><span class="o">,</span> <span class="o">(</span><span class="k">fun</span> <span class="bp">()</span> <span class="o">-&gt;</span> <span class="o">!</span><span class="n">result</span><span class="o">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>The only way to use a record is to delay its construction via a lambda which
must be executed by the test code. Both are complex: what we need is a mutable
data structure which we can access via a reference. A record is not that. We can
approximate it using tricks, but ultimately I find both alternatives to be too
complex to justify their use. Sometimes a mutable data structure is the best
choice to solve your problem efficiently. The power of F# is that it gives us
the ability to choose the best tool for the job: records for immutability,
classes for mutability.</p>
=======
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">interface</span> <span class="n">ICurrentTime</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">DateTime</span> <span class="nf">GetCurrentTime</span><span class="p">();</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">CurrentTime</span> <span class="p">:</span> <span class="n">ICurrentTime</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">public</span> <span class="n">DateTime</span> <span class="nf">GetCurrentTime</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">DateTime</span><span class="p">.</span><span class="n">Now</span><span class="p">();</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">Translator</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">readonly</span> <span class="n">ICurrentTime</span> <span class="n">ct</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="nf">Translator</span><span class="p">()</span> <span class="p">:</span> <span class="k">this</span><span class="p">(</span><span class="k">new</span> <span class="n">CurrentTime</span><span class="p">())</span> <span class="p">{}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="nf">Translator</span><span class="p">(</span><span class="n">ICurrentTime</span> <span class="n">currentTime</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">this</span><span class="p">.</span><span class="n">ct</span> <span class="p">=</span> <span class="n">currentTime</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="kt">string</span> <span class="nf">Translate</span><span class="p">(</span><span class="kt">string</span> <span class="n">input</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="kt">string</span><span class="p">.</span><span class="n">Format</span><span class="p">(</span><span class="s">&quot;{0}: {1}&quot;</span><span class="p">,</span> <span class="n">ct</span><span class="p">.</span><span class="n">GetCurrentTime</span><span class="p">().</span><span class="n">ToString</span><span class="p">(),</span> <span class="n">input</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">/// Test Code with Moq</span>
</span><span class='line'><span class="na">[TestCase]</span>
</span><span class='line'><span class="k">public</span> <span class="k">void</span> <span class="nf">TestCurrentTimeTranslator</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="kt">var</span> <span class="n">rightNow</span> <span class="p">=</span> <span class="n">DateTime</span><span class="p">.</span><span class="n">Now</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">var</span> <span class="n">mock</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Mock</span><span class="p">&lt;</span><span class="n">ICurrentTime</span><span class="p">&gt;();</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">mock</span><span class="p">.</span><span class="n">Setup</span><span class="p">(</span><span class="n">a</span><span class="p">=&gt;</span><span class="n">a</span><span class="p">.</span><span class="n">GetCurrentTime</span><span class="p">()).</span><span class="n">Returns</span><span class="p">(</span><span class="n">rightNow</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="kt">var</span> <span class="n">sut</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Translator</span><span class="p">(</span><span class="n">mock</span><span class="p">.</span><span class="n">Object</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="kt">var</span> <span class="n">result</span> <span class="p">=</span> <span class="n">sut</span><span class="p">.</span><span class="n">Translate</span><span class="p">(</span><span class="s">&quot;test&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">Assert</span><span class="p">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="n">rightNow</span><span class="p">.</span><span class="n">ToString</span><span class="p">()</span> <span class="p">+</span> <span class="s">&quot;: test&quot;</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>If you&rsquo;ve done much C# unit testing, this should look familiar. We want to
inject some code that is potentially long-running or dynamic. We put that code
into a class, add an interface, then inject that interface into the class we
want to test. To test it, we mock the interface, creating a different concrete
class at test runtime which implements that interface. We can setup that mock to
respond with anything, which we use for assertions.</p>

<h1>What&rsquo;s Wrong with the Non-SimpleMock Way?</h1>

<p>The first problem is we have created a whole interface just for testing.
Interfaces are for polymorphism, but we don&rsquo;t really need polymorphism for this
class. We simply want to mock it. The constructor injection is also test code
polluting our business logic.</p>

<p>What we have done is create a very small and primitive dispatch table. The
table has one row: something that has a function with the signature of <code>() -&gt; DateTime</code> or, as it is known in C#: <code>Func&lt;DateTime&gt;</code>.  We will need to make
this primitive dispatch table for every single mock in every single class we
wish to test. That&rsquo;s a lot of boilerplate!</p>
>>>>>>> 9746fb2699c65d83fea530ecbb324e98d6468c7b
</div>
  
  


    </article>
  
  <div class="pagination">
    
<<<<<<< HEAD
      <a class="prev" href="/posts/2">&larr; Older</a>
=======
      <a class="prev" href="/blog/page/2/">&larr; Older</a>
>>>>>>> 9746fb2699c65d83fea530ecbb324e98d6468c7b
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    
<section class="about-me">
  <h1>Steve Shogren</h1>
  <div class="about-text">
    <p>
      Insights gathered while learning to deliberately craft software.
    </p>
  </div>
  <span class="gravatar">
    <img src="http://www.gravatar.com/avatar/772ab2a207cb180ed699d22959b72dd9" alt="Gravatar of Steve Shogren " title="Gravatar of Steve Shogren" />
  </span>
</section>

<section>
  <h1>Top Posts</h1>
  <ul id="recent_posts">
    <li class="post">
      <a href="/ego-driven-development/">Ego Driven Development</a>
    </li>
    <li class="post">
      <a href="/programming-language-safety-algorithm/">Language Safety Score</a>
    </li>

    <li class="post">
      <a href="/intro-to-macros/">Intro To Macros</a>
    </li>
    <li class="post">
      <a href="/function-pattern-matching/">Pattern Matching - Make the Compiler Work for You</a>
    </li>
  </ul>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
<<<<<<< HEAD
        <a href="/f-number-unit-testing/">F# Unit Testing With SimpleMock</a>
      </li>
    
      <li class="post">
=======
>>>>>>> 9746fb2699c65d83fea530ecbb324e98d6468c7b
        <a href="/simplemock-unit-test-mocking/">SimpleMock: Language Agnostic Unit Test Mocking</a>
      </li>
    
      <li class="post">
        <a href="/safety-rank-part-2/">Language Safety Score Mark 2</a>
      </li>
    
      <li class="post">
        <a href="/language-versions/">Language Versions</a>
      </li>
    
      <li class="post">
        <a href="/learning-lisp-was-hard/">Learning Lisp Was Hard</a>
      </li>
    
  </ul>
</section>
<section>
  <h1>Categories</h1>
  <ul id="recent_posts">
    
    
    <li class="post">
<<<<<<< HEAD
      <a href="/blog/categories/technical-skills/"><span>technical skills</span><span style="float:right">20</span></a>
=======
      <a href="/blog/categories/technical-skills/"><span>Technical Skills</span><span style="float:right">19</span></a>
>>>>>>> 9746fb2699c65d83fea530ecbb324e98d6468c7b
    </li>
    
    
    <li class="post">
<<<<<<< HEAD
      <a href="/blog/categories/meta-game/"><span>meta game</span><span style="float:right">23</span></a>
=======
      <a href="/blog/categories/meta-game/"><span>Meta Game</span><span style="float:right">23</span></a>
>>>>>>> 9746fb2699c65d83fea530ecbb324e98d6468c7b
    </li>
    
    
    <li class="post">
<<<<<<< HEAD
      <a href="/blog/categories/unit-testing/"><span>unit testing</span><span style="float:right">1</span></a>
=======
      <a href="/blog/categories/unit-testing/"><span>Unit Testing</span><span style="float:right">1</span></a>
>>>>>>> 9746fb2699c65d83fea530ecbb324e98d6468c7b
    </li>
    
    
    <li class="post">
<<<<<<< HEAD
      <a href="/blog/categories/lisp/"><span>lisp</span><span style="float:right">3</span></a>
=======
      <a href="/blog/categories/lisp/"><span>Lisp</span><span style="float:right">3</span></a>
>>>>>>> 9746fb2699c65d83fea530ecbb324e98d6468c7b
    </li>
    
    
    <li class="post">
<<<<<<< HEAD
      <a href="/blog/categories/clojure/"><span>clojure</span><span style="float:right">2</span></a>
=======
      <a href="/blog/categories/clojure/"><span>Clojure</span><span style="float:right">2</span></a>
>>>>>>> 9746fb2699c65d83fea530ecbb324e98d6468c7b
    </li>
    
    
    <li class="post">
<<<<<<< HEAD
      <a href="/blog/categories/f-number/"><span>f#</span><span style="float:right">2</span></a>
=======
      <a href="/blog/categories/f-number/"><span>F#</span><span style="float:right">2</span></a>
>>>>>>> 9746fb2699c65d83fea530ecbb324e98d6468c7b
    </li>
    
  </ul>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - Steve Shogren -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

<script src="/javascripts/sliders.js" type="text/javascript"></script>
<script src="/javascripts/sliders2.js" type="text/javascript"></script>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
